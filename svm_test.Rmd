---
title: "R Notebook"
output: html_notebook
---



```{r}

library(dplyr)
library(readr)
library(lubridate)
library(broom)
library(Metrics)
library(e1071)
library(ggplot2)


umsatzdaten <- read_csv("umsatzdaten_gekuerzt.csv")
wetter <- read_csv("wetter.csv")
kiwo <- read_csv("kiwo.csv")
feiertage <- read_delim("feiertage.csv", 
    ";", escape_double = FALSE, trim_ws = TRUE)


#Zusammenfügen der Daten und Anfügen weiterer Variablen
#Test
vumsatz <- left_join(umsatzdaten,kiwo)
vumsatz[is.na(vumsatz$KielerWoche),]$KielerWoche<-0
vumsatz=left_join(vumsatz,wetter)
#View(feiertage)
#View(vumsatz)
vumsatz=left_join(vumsatz,feiertage)
vumsatz=subset(vumsatz,select=-c(Heiligerabend_dummy,Silvester_dummy))
#Kodieren des Wetters in einer Variablen
vumsatz$Wetter <- 0
vumsatz[is.na(vumsatz$Wettercode),]$Wetter = 1
vumsatz$Feiertag_Ja=0
vumsatz[is.na(vumsatz$Feiertag),]$Feiertag_Ja = 1
vumsatz[is.na(vumsatz$Feiertag),]$Feiertag = "Nein"
vumsatz$Wochentag <- weekdays(as.Date(vumsatz$Datum))

#Löschen von Zeilen mit NA-Einträgen oder ersetzen durch unsinnige Werte
vumsatz=vumsatz[!is.na(vumsatz$Temperatur),]
vumsatz[is.na(vumsatz$Wettercode),]$Wettercode=-1
vumsatz[is.na(vumsatz$Bewoelkung),]$Bewoelkung=-1
vumsatz$Tag = yday(as.Date(vumsatz$Datum))
#Testen, ob Datensatz NA enthält
#View(vumsatz)
any(is.na(vumsatz$Datum))
any(is.na(vumsatz$Umsatz))
any(is.na(vumsatz$Warengruppe))
any(is.na(vumsatz$KielerWoche))

any(is.na(vumsatz$Temperatur))
any(is.na(vumsatz$Bewoelkung))
any(is.na(vumsatz$Wettercode))
any(is.na(vumsatz$Windgeschwindigkeit))
any(is.na(vumsatz$Wochentag))
any(is.na(vumsatz$Wetter))
any(is.na(vumsatz$Tag))
any(is.na(vumsatz$Feiertag))
any(is.na(vumsatz$Feiertag_Ja))

data_predict=left_join(wetter,kiwo)
data_predict=left_join(data_predict,umsatzdaten)
data_predict=left_join(data_predict,feiertage)
data_predict=subset(data_predict,select=-c(Heiligerabend_dummy,Silvester_dummy))
data_predict$Wetter <- 0
data_predict[is.na(data_predict$Wettercode),]$Wetter = 1
data_predict$Feiertag_Ja=0
data_predict[is.na(data_predict$Feiertag),]$Feiertag_Ja = 1
data_predict[is.na(data_predict$Feiertag),]$Feiertag = "Nein"
data_predict$Wochentag <- weekdays(as.Date(data_predict$Datum))
data_predict=data_predict[!is.na(data_predict$Temperatur),]
data_predict[is.na(data_predict$Wettercode),]$Wettercode=-1
data_predict[is.na(data_predict$Bewoelkung),]$Bewoelkung=-1
data_predict$Tag = yday(as.Date(data_predict$Datum))
data_predict[is.na(data_predict$Umsatz),]$Umsatz=0
data_predict[is.na(data_predict$Warengruppe),]$Warengruppe=0
data_predict[is.na(data_predict$KielerWoche),]$KielerWoche<-0
day_predict <-data.frame("Datum" = "2019-04-06","Warengruppe"=1,"Umsatz"=0,"KielerWoche"=0,"Bewoelkung"=0,"Temperatur"=12.8,"Windgeschwindigkeit"=10,"Wettercode"=10,"Feiertag"="Nein","Wetter"=0,"Feiertag_Ja"=0,"Wochentag"="Samstag","Tag"=96)
```
```{r}
# Zufallszähler setzen (um die zufällige Partitionierung bei jedem Durchlauf gleich zu halten)
set.seed(1)

# Zufällige Ziehung Indizes für die Zeilen des Datensatzes, die dem Traininsdatensatz zugeordnet werden
indices_train <- sample(seq_len(nrow(vumsatz)), size = floor(0.80 * nrow(vumsatz)))

# Definition des Trainings- und Testdatensatz durch Selektion bzw. Deselektion der entsprechenden Datenzeilen
umsatz_train <- umsatz_train_org <- vumsatz[indices_train, ]
umsatz_test <- vumsatz[-indices_train, ]


#Verkleinerung des Datensatzes zu Testzwecken
#umsatz_train <- sample_frac(umsatz_train_org, .50)
# warengruppe=1
# umsatz_train=umsatz_train[umsatz_train$Warengruppe==warengruppe,]
# umsatz_test=umsatz_test[umsatz_test$Warengruppe==warengruppe,]
```


```{r}
#Berechnen von linearem Modell
# mod2 <-
#   lm(
#     Umsatz ~ as.factor(Feiertag_Ja) + Temperatur + as.factor(KielerWoche) + as.factor(Wochentag) +
#       as.factor(Wetter) + Tag + Bewoelkung,
#     umsatz_train
#   )
# 
# mape(umsatz_train$Umsatz, predict(mod2, new_data = umsatz_train))

#Berechnung des svm Modells
svm_tune <-
  tune(
    svm,
    Umsatz ~ as.factor(KielerWoche) + as.factor(Wetter) + Temperatur + as.Date(Datum)  + as.factor(Wochentag) + Bewoelkung ,
    data = umsatz_train,
    ranges = list(epsilon = seq(0.1, 1, 0.1), cost = 2 ^ (0:3))
  )


#Errechnen des relativen Fehlers für Trainingsdaten
pred_best <- predict(svm_tune$best.model, umsatz_train)
mape(umsatz_train$Umsatz, pred_best)

#Errechnen des relativen Fehlers für Testdaten
test_best <- predict(svm_tune$best.model, umsatz_test)
mape(umsatz_test$Umsatz, test_best)

#Darstellen der Daten
vumsatz_plot <- vumsatz[vumsatz$Warengruppe == warengruppe, ]
vumsatz_plot$Jahr = year(as.Date(vumsatz_plot$Datum))
vumsatz_plot$svm <- predict(svm_tune$best.model, vumsatz_plot)
ggplot(vumsatz_plot) + geom_point(aes(x = Datum, y = Umsatz, color = "red")) +
  geom_line(aes(x = Datum, y = svm))
```
```{r}
vumsatz1<-predict(svm_tune$best.model,data_predict)
vumsatz1[data_predict$Datum=="2019-06-04"]
data_predict[data_predict$Datum=="2019-06-04",]
```

```{r}

warengruppe=1
umsatz_trainw=umsatz_train[umsatz_train$Warengruppe==warengruppe,]
umsatz_testw=umsatz_test[umsatz_test$Warengruppe==warengruppe,]
svm_tune1 <-
  tune(
    svm,
    Umsatz ~  as.factor(KielerWoche) + as.factor(Wetter) + Temperatur + as.Date(Datum)  + as.factor(Wochentag) + Bewoelkung ,
    data = umsatz_trainw,
    ranges = list(epsilon = seq(0.1, 1, 0.1), cost = 2 ^ (0:3))
  )


warengruppe=2
umsatz_trainw=umsatz_train[umsatz_train$Warengruppe==warengruppe,]
umsatz_testw=umsatz_test[umsatz_test$Warengruppe==warengruppe,]
svm_tune2 <-
  tune(
    svm,
    Umsatz ~ as.factor(KielerWoche) + as.factor(Wetter) + Temperatur + as.Date(Datum)  + as.factor(Wochentag) + Bewoelkung ,
    data = umsatz_trainw,
    ranges = list(epsilon = seq(0.1, 1, 0.1), cost = 2 ^ (0:3))
  )


warengruppe=3
umsatz_trainw=umsatz_train[umsatz_train$Warengruppe==warengruppe,]
umsatz_testw=umsatz_test[umsatz_test$Warengruppe==warengruppe,]
svm_tune3 <-
  tune(
    svm,
    Umsatz ~ as.factor(KielerWoche) + as.factor(Wetter) + Temperatur + as.Date(Datum)  + as.factor(Wochentag) + Bewoelkung ,
    data = umsatz_trainw,
    ranges = list(epsilon = seq(0.1, 1, 0.1), cost = 2 ^ (0:3))
  )


warengruppe=4
umsatz_trainw=umsatz_train[umsatz_train$Warengruppe==warengruppe,]
umsatz_testw=umsatz_test[umsatz_test$Warengruppe==warengruppe,]
svm_tune4 <-
  tune(
    svm,
    Umsatz ~ as.factor(KielerWoche) + as.factor(Wetter) + Temperatur + as.Date(Datum)  + as.factor(Wochentag) + Bewoelkung ,
    data = umsatz_trainw,
    ranges = list(epsilon = seq(0.1, 1, 0.1), cost = 2 ^ (0:3))
  )


warengruppe=5
umsatz_trainw=umsatz_train[umsatz_train$Warengruppe==warengruppe,]
umsatz_testw=umsatz_test[umsatz_test$Warengruppe==warengruppe,]
svm_tune5<-
  tune(
    svm,
    Umsatz ~ as.factor(KielerWoche) + as.factor(Wetter) + Temperatur + as.Date(Datum)  + as.factor(Wochentag) + Bewoelkung ,
    data = umsatz_trainw,
    ranges = list(epsilon = seq(0.1, 1, 0.1), cost = 2 ^ (0:3))
  )

# warengruppe=6
# umsatz_trainw=umsatz_train[umsatz_train$Warengruppe==warengruppe,]
# umsatz_testw=umsatz_test[umsatz_test$Warengruppe==warengruppe,]
# svm_tune6 <-
#   tune(
#     svm,
#     Umsatz ~as.factor(KielerWoche) + as.factor(Wetter) + Temperatur + as.Date(Datum)  + as.factor(Wochentag) + Bewoelkung ,
#     data = umsatz_trainw,
#     ranges = list(epsilon = seq(0.1, 1, 0.1), cost = 2 ^ (0:3))
#   )



```

```{r}
vumsatz1<-predict(svm_tune1$best.model,data_predict)
vumsatz2<-predict(svm_tune2$best.model,data_predict)
vumsatz3<-predict(svm_tune3$best.model,data_predict)
vumsatz4<-predict(svm_tune4$best.model,data_predict)
vumsatz5<-predict(svm_tune5$best.model,data_predict)
#vumsatz6<-predict(svm_tune6$best.model,data_predict)

Umsatz_predict = c(vumsatz1[data_predict$Datum=="2019-06-04"],vumsatz2[data_predict$Datum=="2019-06-04"],vumsatz3[data_predict$Datum=="2019-06-04"],vumsatz4[data_predict$Datum=="2019-06-04"],vumsatz5[data_predict$Datum=="2019-06-04"])
print(Umsatz_predict)
print(sum(Umsatz_predict))
```

